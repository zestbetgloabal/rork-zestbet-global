version: 1
frontend:
  phases:
    preBuild:
      commands:
        - 'npm install'
        - 'echo Installing backend dependencies...'
        - 'cd backend && npm install'
    build:
      commands:
        - 'echo Starting Expo web export'
        - 'npx expo export --platform web --output-dir dist --clear'
        - 'echo Finding generated web entry file'
        - 'ENTRY_FILE=$(find dist/_expo/static/js/web -maxdepth 1 -type f -name "entry-*.js" | head -n 1) && echo ENTRY_FILE=$ENTRY_FILE'
        - 'if [ -z "$ENTRY_FILE" ]; then echo ERROR Could not find entry js; ls -lah dist/_expo/static/js/web || true; exit 1; fi'
        - 'ENTRY_BASENAME=$(basename "$ENTRY_FILE") && echo Found $ENTRY_BASENAME'
        - 'sed -i "s#</head>#<script type=\"module\" src=\"/_expo/static/js/web/${ENTRY_BASENAME}\"></script></head>#g" dist/index.html'
        - 'echo Injected web entry into index'
        - 'echo Building backend for Lambda...'
        - 'npx esbuild backend/amplify/index.ts --bundle --platform=node --target=node18 --outfile=backend/dist/index.js --external:@aws-sdk/*'
        - 'echo Copying Lambda function to dist...'
        - 'mkdir -p dist/api && cp backend/dist/index.js dist/api/'
        - 'echo Creating API routing configuration...'
        - 'echo "/*    /index.html   200" > dist/_redirects'
        - 'echo "/api/*  /api/index.js  200" >> dist/_redirects'
        - 'echo "Creating API handler for Amplify..."'
        - 'cp backend/dist/index.js dist/api/index.js'
    postBuild:
      commands:
        - 'cp dist/index.html dist/200.html || copy dist/index.html dist/200.html || true'
        - 'cp dist/index.html dist/404.html || copy dist/index.html dist/404.html || true'
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - backend/node_modules/**/*