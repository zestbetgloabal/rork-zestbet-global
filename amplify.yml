version: 1
frontend:
  phases:
    preBuild:
      commands:
        - 'npm install'
        - 'echo Creating temporary backend package.json for Expo...'
        - 'echo "{\"name\": \"backend\", \"version\": \"1.0.0\", \"private\": true}" > backend/package.json'
        - 'echo Backend dependencies are included in main package.json'
    build:
      commands:
        - 'echo Starting Expo web export'
        - 'echo Setting environment variables for build...'
        - 'export EXPO_PUBLIC_API_URL=https://zestapp.online/api'
        - 'export EXPO_PUBLIC_TRPC_URL=https://zestapp.online/api/trpc'
        - 'echo EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL'
        - 'echo EXPO_PUBLIC_TRPC_URL=$EXPO_PUBLIC_TRPC_URL'
        - 'EXPO_NO_METRO_LAZY=1 npx expo export --platform web --output-dir dist --clear'
        - 'echo Finding generated web entry file'
        - 'ENTRY_FILE=$(find dist/_expo/static/js/web -maxdepth 1 -type f -name "entry-*.js" | head -n 1) && echo ENTRY_FILE=$ENTRY_FILE'
        - 'if [ -z "$ENTRY_FILE" ]; then echo ERROR Could not find entry js; ls -lah dist/_expo/static/js/web || true; exit 1; fi'
        - 'ENTRY_BASENAME=$(basename "$ENTRY_FILE") && echo Found $ENTRY_BASENAME'
        - 'sed -i "s#</head>#<script type=\"module\" src=\"/_expo/static/js/web/${ENTRY_BASENAME}\"></script></head>#g" dist/index.html'
        - 'echo Injected web entry into index'
        - 'echo Creating simple API proxy configuration...'
        - 'echo "Creating _redirects file for routing..."'
        - 'echo "/*    /index.html   200" > dist/_redirects'
        - 'echo "# API routes will be handled by external backend" >> dist/_redirects'
    postBuild:
      commands:
        - 'cp dist/index.html dist/200.html || copy dist/index.html dist/200.html || true'
        - 'cp dist/index.html dist/404.html || copy dist/index.html dist/404.html || true'
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*