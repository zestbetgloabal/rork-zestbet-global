version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - echo "Starting Expo web export"
        - npx expo export --platform web --output-dir dist --clear --no-bundler
        - echo "Looking for generated web entry file"
        - ENTRY_FILE=$(find dist/_expo/static/js/web -maxdepth 1 -type f -name 'entry-*.js' | head -n 1)
        - |
          if [ -z "$ENTRY_FILE" ]; then
            echo "ERROR: Could not find entry-*.js in dist/_expo/static/js/web";
            echo "Listing dist/_expo/static/js/web for debugging:";
            ls -lah dist/_expo/static/js/web || true;
            exit 1;
          fi
        - ENTRY_BASENAME=$(basename "$ENTRY_FILE")
        - echo "Found web entry: $ENTRY_BASENAME"
        - |
          sed -i "s#</head>#<script type=\"module\" src=\"/_expo/static/js/web/${ENTRY_BASENAME}\"></script></head>#" dist/index.html
        - echo "Injected web entry into index.html"
    postBuild:
      commands:
        - cp dist/index.html dist/200.html || copy dist/index.html dist/200.html
        - cp dist/index.html dist/404.html || copy dist/index.html dist/404.html
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*